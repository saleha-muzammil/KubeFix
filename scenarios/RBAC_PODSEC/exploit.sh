#!/usr/bin/env bash
set -euo pipefail

NS=rbac-podsec

echo "[*] Pods in $NS"
kubectl -n "$NS" get pods -o wide

echo "[*] ClusterRole nginx-overperm:"
kubectl get clusterrole nginx-overperm -o yaml

echo "[*] ClusterRoleBinding nginx-overperm-binding:"
kubectl get clusterrolebinding nginx-overperm-binding -o yaml

echo "[*] Checking what nginx-sa can do (sample can-i checks):"
kubectl auth can-i list pods       --as=system:serviceaccount:$NS:nginx-sa --all-namespaces
kubectl auth can-i get secrets     --as=system:serviceaccount:$NS:nginx-sa --all-namespaces
kubectl auth can-i delete pods     --as=system:serviceaccount:$NS:nginx-sa --all-namespaces || true

